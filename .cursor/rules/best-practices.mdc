---
description: Coding standards and best practices for the Materi Document Editor
alwaysApply: true
---
# Best Practices

## TypeScript
- Strict mode is on. Never use `any` — use `unknown` and narrow, or define a proper type.
- All shared types live in `src/shared/types.ts`. Don't redeclare `EditorDocument` or `LayoutResult` locally.
- The document model type is `EditorDocument`, not `Document`, to avoid collision with the global DOM `Document` interface. Use this name consistently everywhere.
- All layout constants live in `src/shared/constants.ts`. Never hardcode page dimensions or margins.
- Prefer `interface` for object shapes, `type` for unions and computed types.
- Use explicit return types on exported functions. Omit return types on React components — let TypeScript infer them.

## React (src/client/)
- Functional components only. No class components.
- Colocate component logic — keep hooks, handlers, and JSX in the same file until complexity warrants extraction.
- Avoid `useEffect` for derived state. Compute during render where possible.
- Props should be typed with an explicit interface, not inline.
- Never store TipTap editor state in React state — use `editor.getJSON()` for saving and `editor.commands.setContent()` for loading. The editor instance is the source of truth during editing.

## TipTap / ProseMirror
- TipTap Decorations are visual-only. Never inject content into the document tree for layout purposes.
- `getJSON()` is the persistence boundary. Anything that shouldn't persist (page gaps, overlays) must not appear in the document model.
- Layout-triggered transactions (e.g. mid-paragraph splits in Phase 10) must use `addToHistory: false` to keep undo/redo clean.
- Access ProseMirror APIs through `@tiptap/pm` — don't install `prosemirror-*` packages directly.

## Layout Engine
- The layout engine must be a pure function: DOM measurements in, `LayoutResult` out. No side effects, no DOM mutations.
- Batch all DOM reads (`getBoundingClientRect`, `getClientRects`) in a single pass to avoid layout thrashing.
- Debounce layout recalculation (100–150ms) on editor updates. Never run synchronously on every keystroke.
- Gate the first layout pass on `document.fonts.ready` to ensure deterministic measurement.
- Measure before decorating. Apply decoration margins only after layout is computed to avoid feedback loops.
- Remeasure from the dirty paragraph onwards where implemented. Full reflow over all paragraphs is acceptable for V1.

## Express Backend (src/server/)
- Keep the server minimal. Two endpoints: `POST /documents`, `GET /documents/:id`.
- In-memory storage with a `Map<string, EditorDocument>`. No database, no ORM.
- Server sets `created_at` and `updated_at` — clients don't send timestamps.
- Return proper HTTP status codes: 201 on create, 200 on get, 404 on not found.
- Enable CORS for local dev via the `cors` middleware.

## API Client (src/client/)
- API client functions must return typed success/error states — not raw fetch responses.
- Save and load UI must surface errors to the user (e.g. toast, inline message). No silent failures, no unhandled promise rejections.
- Handle at minimum: network failure, 404 on load, and server validation errors.

## Save/Load (Persistence)

- Save sends `editor.getJSON()` as `content`; load uses `editor.commands.setContent(doc.content)`. No custom serialisation format.
- Any change to save/load must be verified with a manual round-trip test: save → hard refresh → load by ID → visually compare content structure and pagination.
- The persisted document model must never contain layout artifacts (decorations, page breaks, split markers). These are recomputed on load.

## DOM Measurement
- Batch reads, then batch writes. Never interleave reads and writes.
- Overlays (`PageOverlay`) must be `pointer-events: none` and `position: absolute` — zero impact on content flow or measurements.

## CSS Constants Bridge
- Layout constants are shared between TypeScript and CSS via CSS custom properties set in `src/client/initCssVars.ts`.
- This file reads from `src/shared/constants.ts` and calls `document.documentElement.style.setProperty()` for each value (e.g. `--page-width: 794px`, `--margin-top: 96px`).
- CSS files must reference `var(--page-width)` etc. Never hardcode layout pixel values in CSS.
- `initCssVars.ts` runs once at app startup, before the editor mounts.

## Project Structure
- `src/client/` — React app, components, engine, API client.
- `src/server/` — Express backend.
- `src/shared/` — Types and constants shared by both. Never import client code from server or vice versa.

## General
- Determinism over features. Prefer a correct, simple implementation over a featureful brittle one.
- No dead code. Remove unused imports, functions, and variables.
- No `console.log` in committed code except for server startup and explicit error handling.
- Handle errors explicitly — no empty catch blocks, no swallowed promises.
